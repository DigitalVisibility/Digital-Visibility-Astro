---
/**
 * BlogPost-Reference.astro
 * Layout for AI-generated blog posts from n8n workflow
 * Location: src/layouts/BlogPost-Reference.astro
 * 
 * Uses: MainLayout wrapper + Navigation/Footer slots (same as old blogs)
 * Renders: All workflow content (hero, TOC, testimonials, schema, etc.)
 */

import MainLayout from './MainLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

export const prerender = true;

// ═══════════════════════════════════════════════════════════
// GET ALL FRONTMATTER DATA
// ═══════════════════════════════════════════════════════════
const { frontmatter, compiledContent } = Astro.props;

// Extract all data from frontmatter
const {
  title,
  description,
  pubDate,
  updatedDate,
  author,
  slug,
  canonical,
  category,
  tags = [],
  keywords = [],
  primaryKeyword,
  heroImage,
  readTime,
  wordCount,
  og,
  twitterCard,
  twitterSite,
  inLanguage = 'en-GB',
  contentLocation = 'UK',
  areaServed = [],
  enableTOC = true,
  enableSharing = true,
  shareButtons = { twitter: true, facebook: true, linkedin: true },
  testimonial,
  cta,
  conversionOptimization = {},
  schema // JSON string from workflow
} = frontmatter;

// ═══════════════════════════════════════════════════════════
// PARSE SCHEMA FROM WORKFLOW
// Schema comes as double-JSON-encoded string
// ═══════════════════════════════════════════════════════════
let schemaObject;
try {
  schemaObject = JSON.parse(schema);
} catch (error) {
  console.error('Schema parsing error:', error);
  // Fallback basic schema
  schemaObject = {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": title
  };
}

// ═══════════════════════════════════════════════════════════
// GENERATE TOC FROM CONTENT (if not provided)
// ═══════════════════════════════════════════════════════════
const content = compiledContent();
const tocRegex = /^#{2,3}\s+(.+)$/gm;
let tocItems = [];
let match;

while ((match = tocRegex.exec(content)) !== null) {
  const heading = match[1];
  const id = heading
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
  
  tocItems.push({
    id: id,
    title: heading,
    level: match[0].startsWith('###') ? 3 : 2
  });
}

// Format publish date
const publishDate = new Date(pubDate).toLocaleDateString('en-GB', { 
  year: 'numeric', 
  month: 'long', 
  day: 'numeric' 
});

// Share URLs
const pageUrl = `https://digitalvisibility.com/blog/${slug}`;
const shareUrl = encodeURIComponent(pageUrl);
const shareText = encodeURIComponent(title);
---

<MainLayout 
  title={title + " | Digital Visibility Blog"} 
  metaOgImage={heroImage?.url}
  metaTwitterImage={heroImage?.url}
>
  <!-- Meta Tags -->
  <meta name="description" content={description} slot="head" />
  <meta name="keywords" content={keywords.join(", ")} slot="head" />
  <link rel="canonical" href={canonical} slot="head" />
  
  <!-- Open Graph -->
  <meta property="og:title" content={og?.title || title} slot="head" />
  <meta property="og:description" content={og?.description || description} slot="head" />
  <meta property="og:image" content={og?.image || heroImage?.url} slot="head" />
  <meta property="og:type" content="article" slot="head" />
  <meta property="og:url" content={pageUrl} slot="head" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" slot="head" />
  <meta name="twitter:site" content={twitterSite || '@digitalvisibility'} slot="head" />
  <meta name="twitter:title" content={title} slot="head" />
  <meta name="twitter:description" content={description} slot="head" />
  <meta name="twitter:image" content={heroImage?.url} slot="head" />
  
  <Navigation slot="nav" />
  
  <article class="article">
    <!-- Hero Section with Image -->
    <div class="relative">
      {heroImage?.url ? (
        <div class="w-full h-[400px] overflow-hidden">
          <img 
            src={heroImage.url} 
            alt={heroImage.alt || title}
            class="w-full h-full object-cover"
            loading="eager"
          />
        </div>
      ) : (
        <div class="w-full h-[400px] bg-gradient-to-b from-blue-900 to-blue-800"></div>
      )}
      <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end">
        <div class="max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <div class="text-white max-w-3xl">
            <div class="mb-4 flex items-center">
              <span class="bg-blue-600 text-white text-sm px-3 py-1 rounded-full font-medium">
                {category}
              </span>
            </div>
            <h1 class="text-4xl sm:text-5xl font-bold mb-4 leading-tight">{title}</h1>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="py-8 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Publication info and share links -->
        <div class="mb-8 pb-4 border-b border-gray-200 flex flex-wrap items-center justify-between">
          <div class="flex items-center space-x-4 mb-4 sm:mb-0">
            <div class="flex items-center">
              <i data-lucide="calendar" class="w-4 h-4 mr-1 text-gray-500"></i>
              <span class="text-sm text-gray-600">{publishDate}</span>
            </div>
            <div class="flex items-center">
              <i data-lucide="clock" class="w-4 h-4 mr-1 text-gray-500"></i>
              <span class="text-sm text-gray-600">{readTime}</span>
            </div>
          </div>
          
          {enableSharing && (
            <div class="flex items-center">
              <span class="text-sm text-gray-600 mr-3">Share:</span>
              <div class="flex space-x-3">
                {shareButtons.twitter && (
                  <a 
                    href={`https://twitter.com/intent/tweet?url=${shareUrl}&text=${shareText}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    aria-label="Share on Twitter" 
                    class="text-gray-500 hover:text-blue-600"
                  >
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723 10.059 10.059 0 01-3.127 1.184 4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.937 4.937 0 004.604 3.417 9.868 9.868 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63a9.936 9.936 0 002.46-2.548l-.047-.02z"></path>
                    </svg>
                  </a>
                )}
                {shareButtons.linkedin && (
                  <a 
                    href={`https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    aria-label="Share on LinkedIn" 
                    class="text-gray-500 hover:text-blue-600"
                  >
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path>
                    </svg>
                  </a>
                )}
                {shareButtons.facebook && (
                  <a 
                    href={`https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    aria-label="Share on Facebook" 
                    class="text-gray-500 hover:text-blue-600"
                  >
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"></path>
                    </svg>
                  </a>
                )}
              </div>
            </div>
          )}
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
          <!-- Main Content (renders markdown from workflow) -->
          <div class="lg:col-span-8 order-2 lg:order-1">
            <div class="prose prose-lg max-w-none">
              <slot />
            </div>
            
            <!-- Author Section -->
            <div class="border-t border-gray-200 pt-8 mt-12">
              <h2 class="text-2xl font-bold text-gray-900 mb-6">About the Author</h2>
              <div class="flex items-start">
                <img 
                  src={author?.image || '/Darran-Goulding-Royal-Academy-of-Engineering-Image.webp'}
                  alt={author?.name || 'Darran Goulding'} 
                  class="w-20 h-20 rounded-full mr-6 object-cover flex-shrink-0"
                  loading="lazy"
                />
                <div>
                  <h3 class="text-xl font-bold text-gray-900 mb-2">{author?.name || 'Darran Goulding'}</h3>
                  <p class="text-gray-700 mb-4">
                    {author?.name || 'Darran Goulding'} is the founder of Digital Visibility, specializing in AI-powered SEO, automation, and digital strategy. With over 20 years of experience in digital marketing and web development, Darran helps businesses optimize for both traditional search engines and AI platforms like ChatGPT, Claude, and Perplexity.
                  </p>
                  <a href={author?.url || '/about/darran-goulding/'} class="text-blue-600 hover:text-blue-800 font-medium">
                    View Full Profile →
                  </a>
                </div>
              </div>
            </div>
            
            <!-- Comments Section -->
            <div class="border border-gray-200 rounded-lg p-8 mt-12 bg-gray-50 text-center">
              <h3 class="text-xl font-bold text-gray-900 mb-3">We'd Love to Hear Your Thoughts!</h3>
              <p class="text-gray-700 mb-6 max-w-2xl mx-auto">
                Have a question about these strategies? Want to share your own experience? Your insights are valuable to our community. Reach out to us directly and we'll be happy to continue the conversation.
              </p>
              <a 
                href="/contact/"
                class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium px-8 py-3 rounded-md transition-colors shadow-md"
              >
                Contact Us to Comment
              </a>
            </div>
          </div>
          
          <!-- Sidebar -->
          <aside class="lg:col-span-4 order-1 lg:order-2">
            <div class="sticky top-8 space-y-8">
              <!-- Category Badge -->
              <div>
                <span class="inline-block bg-blue-100 text-blue-700 rounded-full px-3 py-1 text-xs font-medium mr-2 mb-2">
                  {category}
                </span>
              </div>
              
              <!-- Table of Contents -->
              {enableTOC && tocItems.length > 0 && (
                <div class="bg-gray-50 rounded-lg p-6">
                  <h2 class="text-lg font-bold text-gray-900 mb-4">Table of Contents</h2>
                  <nav class="space-y-2 text-sm">
                    {tocItems.map((item) => (
                      <a 
                        href={`#${item.id}`}
                        class={`block text-gray-700 hover:text-blue-600 transition-colors ${item.level === 3 ? 'pl-4' : ''}`}
                      >
                        {item.title}
                      </a>
                    ))}
                  </nav>
                </div>
              )}
              
              <!-- Testimonial Card (from workflow) -->
              {testimonial && (
                <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-200 rounded-lg p-6">
                  <div class="text-4xl text-blue-600 opacity-30 mb-2">"</div>
                  <p class="text-gray-800 italic mb-4">{testimonial.quote}</p>
                  <div class="mb-3">
                    <div class="font-bold text-gray-900">{testimonial.author}</div>
                    <div class="text-sm text-gray-600">{testimonial.role} at {testimonial.company}</div>
                  </div>
                  <div class="flex text-yellow-400">
                    {Array.from({ length: testimonial.rating || 5 }).map(() => (
                      <span>★</span>
                    ))}
                  </div>
                </div>
              )}
              
              <!-- CTA Box (from workflow) -->
              {cta?.enable && (
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                  <h3 class="text-lg font-bold text-gray-900 mb-2">{cta.title}</h3>
                  <p class="text-gray-700 text-sm mb-4">{cta.description}</p>
                  <a 
                    href={cta.buttonUrl}
                    class="block bg-blue-600 hover:bg-blue-700 text-white text-center font-medium px-4 py-2 rounded-md transition-colors"
                  >
                    {cta.buttonText}
                  </a>
                </div>
              )}
              
              <!-- Author Bio Card -->
              <div class="border border-gray-200 rounded-lg p-6 text-center">
                <img 
                  src={author?.image || '/Darran-Goulding-Royal-Academy-of-Engineering-Image.webp'}
                  alt={author?.name || 'Darran Goulding'} 
                  class="w-16 h-16 rounded-full mx-auto mb-3 object-cover"
                  loading="lazy"
                />
                <h4 class="font-bold text-gray-900 mb-1">{author?.name || 'Darran Goulding'}</h4>
                <p class="text-sm text-gray-600 mb-3">SEO Expert & Founder</p>
                <a href={author?.url || '/about/darran-goulding/'} class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                  View Profile →
                </a>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </article>
  
  <!-- Newsletter CTA Section -->
  <section class="py-12 bg-gradient-to-r from-blue-600 to-blue-800 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="text-3xl font-bold mb-4">Never Miss an SEO Update</h2>
        <p class="text-lg opacity-90 mb-6">
          Stay ahead of the competition with our monthly newsletter featuring exclusive SEO strategies, digital marketing trends, and actionable tips you won't find anywhere else.
        </p>
        <div class="flex flex-col items-center">
          <a 
            href="/contact/"
            class="bg-white text-blue-800 hover:bg-blue-50 font-medium px-8 py-3 rounded-md transition-colors shadow-md inline-block"
          >
            Join Our Exclusive Newsletter
          </a>
          <p class="text-sm opacity-90 mt-6 max-w-lg">
            Visit our contact page to sign up for our monthly insights. We carefully curate valuable content that helps businesses like yours succeed in the ever-changing digital landscape.
          </p>
        </div>
      </div>
    </div>
  </section>
  
  <Footer />
  
  <!-- Advanced Schema Markup from Workflow (in head via script tag) -->
  <script type="application/ld+json" set:html={JSON.stringify(schemaObject)} />
</MainLayout>