---
// BlogPost.astro Layout
// Location: src/layouts/BlogPost.astro

import { getCollection } from 'astro:content';

const { frontmatter } = Astro.props;
const { Content } = Astro.props;

// Generate TOC from content headings
function generateTOC(content: string) {
  const headingRegex = /^## (.+)$/gm;
  const headings = [];
  let match;
  
  while ((match = headingRegex.exec(content)) !== null) {
    const text = match[1].replace(/\{#[^}]+\}/, '').trim(); // Remove ID syntax
    const id = text
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim();
    
    headings.push({ text, id });
  }
  
  return headings;
}

// Get raw content for TOC generation (you'll need to pass this from your content)
const tocItems = frontmatter.enableTOC ? generateTOC(Astro.props.rawContent || '') : [];

---

<!DOCTYPE html>
<html lang={frontmatter.inLanguage || 'en-GB'}>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- SEO Meta Tags -->
  <title>{frontmatter.title} | Digital Visibility</title>
  <meta name="description" content={frontmatter.description} />
  <link rel="canonical" href={frontmatter.canonical} />
  
  <!-- Open Graph -->
  <meta property="og:title" content={frontmatter.og?.title || frontmatter.title} />
  <meta property="og:description" content={frontmatter.og?.description || frontmatter.description} />
  <meta property="og:image" content={frontmatter.og?.image || frontmatter.heroImage?.url} />
  <meta property="og:type" content={frontmatter.og?.type || 'article'} />
  <meta property="og:url" content={frontmatter.og?.url || frontmatter.canonical} />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content={frontmatter.twitterCard || 'summary_large_image'} />
  <meta name="twitter:site" content={frontmatter.twitterSite || '@digitalvisibility'} />
  <meta name="twitter:title" content={frontmatter.title} />
  <meta name="twitter:description" content={frontmatter.description} />
  <meta name="twitter:image" content={frontmatter.heroImage?.url} />
  
  <!-- Schema.org JSON-LD -->
  {frontmatter.schema && (
    <script type="application/ld+json" set:html={JSON.stringify(frontmatter.schema)} />
  )}
  
  <!-- Article Meta -->
  {frontmatter.pubDate && <meta property="article:published_time" content={frontmatter.pubDate} />}
  {frontmatter.updatedDate && <meta property="article:modified_time" content={frontmatter.updatedDate} />}
  
  <!-- Your main CSS files -->
  <link rel="stylesheet" href="/styles/global.css" />
  <link rel="stylesheet" href="/styles/blog.css" />
</head>

<body class="blog-post">
  <!-- Navigation (your existing nav component) -->
  <nav class="site-navigation">
    <a href="/">Home</a>
    <a href="/blog">Blog</a>
    <a href="/about">About</a>
    <a href="/contact">Contact</a>
  </nav>
  
  <!-- Breadcrumbs -->
  <div class="breadcrumbs">
    <a href="/">Home</a> / 
    <a href="/blog">Blog</a> / 
    <span>{frontmatter.category || 'A/B Testing'}</span>
  </div>
  
  <!-- Main Content Area -->
  <div class="blog-container">
    
    <!-- LEFT/CENTER: Main Article -->
    <article class="blog-content">
      
      <!-- Article Header -->
      <header class="article-header">
        <h1>{frontmatter.title}</h1>
        
        <!-- Author Info -->
        {frontmatter.author && (
          <div class="author-meta">
            <img src={frontmatter.author.image} alt={frontmatter.author.name} class="author-avatar" />
            <div>
              <span class="author-name">By <a href={frontmatter.author.url}>{frontmatter.author.name}</a></span>
              {frontmatter.author2 && (
                <span> and <a href={frontmatter.author2.url}>{frontmatter.author2.name}</a></span>
              )}
            </div>
          </div>
        )}
        
        <!-- Article Meta -->
        <div class="article-meta">
          <time datetime={frontmatter.pubDate}>
            {new Date(frontmatter.pubDate).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </time>
          {frontmatter.readTime && <span>· {frontmatter.readTime}</span>}
        </div>
        
        <!-- "Not by AI" Badge (if present) -->
        {frontmatter.notByAI && (
          <div class="not-by-ai-badge">
            <span>✍️ Written by Human</span>
          </div>
        )}
      </header>
      
      <!-- Hero Image -->
      {frontmatter.heroImage && (
        <figure class="hero-image">
          <img 
            src={frontmatter.heroImage.url} 
            alt={frontmatter.heroImage.alt || frontmatter.title}
            loading="eager"
          />
          {frontmatter.heroImage.caption && (
            <figcaption>{frontmatter.heroImage.caption}</figcaption>
          )}
        </figure>
      )}
      
      <!-- Main Content (from markdown) -->
      <div class="prose">
        <slot />
      </div>
      
    </article>
    
    <!-- RIGHT: Sidebar -->
    <aside class="blog-sidebar">
      
      <!-- Share Buttons -->
      {frontmatter.enableSharing && frontmatter.shareButtons && (
        <div class="share-section sticky-section">
          <h3>Share:</h3>
          <div class="share-buttons">
            {frontmatter.shareButtons.twitter && (
              <a 
                href={`https://twitter.com/intent/tweet?url=${frontmatter.canonical}&text=${encodeURIComponent(frontmatter.title)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="share-button twitter"
                aria-label="Share on Twitter"
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
              </a>
            )}
            {frontmatter.shareButtons.facebook && (
              <a 
                href={`https://www.facebook.com/sharer/sharer.php?u=${frontmatter.canonical}`}
                target="_blank"
                rel="noopener noreferrer"
                class="share-button facebook"
                aria-label="Share on Facebook"
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a8.68 8.68 0 0 1 1.141.195v3.325a8.623 8.623 0 0 0-.653-.036 26.805 26.805 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.686 1.686 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 3.667h-3.533v7.98H9.101z"/>
                </svg>
              </a>
            )}
            {frontmatter.shareButtons.linkedin && (
              <a 
                href={`https://www.linkedin.com/sharing/share-offsite/?url=${frontmatter.canonical}`}
                target="_blank"
                rel="noopener noreferrer"
                class="share-button linkedin"
                aria-label="Share on LinkedIn"
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19a.66.66 0 000 .14V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/>
                </svg>
              </a>
            )}
          </div>
        </div>
      )}
      
      <!-- Table of Contents -->
      {frontmatter.enableTOC && tocItems.length > 0 && (
        <div class="toc-section sticky-section">
          <h3>Sections</h3>
          <nav class="table-of-contents" aria-label="Table of Contents">
            <ul>
              {tocItems.map(item => (
                <li>
                  <a href={`#${item.id}`} class="toc-link">
                    {item.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </div>
      )}
      
      <!-- CTA Box -->
      {frontmatter.cta?.enable && (
        <div class="cta-box sticky-section">
          <h3>{frontmatter.cta.title}</h3>
          <p>{frontmatter.cta.description}</p>
          <a href={frontmatter.cta.buttonUrl} class={`cta-button ${frontmatter.cta.theme || 'primary'}`}>
            {frontmatter.cta.buttonText}
          </a>
        </div>
      )}
      
      <!-- Author Bio Card -->
      {frontmatter.author && (
        <div class="author-bio-card sticky-section">
          <img src={frontmatter.author.image} alt={frontmatter.author.name} />
          <h4>{frontmatter.author.name}</h4>
          <p class="author-title">SEO Expert & Founder of Digital Visibility</p>
          <a href={frontmatter.author.url} class="view-profile-link">View Full Profile →</a>
        </div>
      )}
      
    </aside>
    
  </div>
  
  <!-- Footer -->
  <footer class="site-footer">
    <p>&copy; 2025 Digital Visibility. All rights reserved.</p>
  </footer>
  
  <!-- Smooth Scroll Script for TOC -->
  <script>
    document.querySelectorAll('.toc-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
          
          // Update URL without jumping
          history.pushState(null, null, `#${targetId}`);
        }
      });
    });
    
    // Highlight active section in TOC on scroll
    const observerOptions = {
      root: null,
      rootMargin: '-20% 0px -80% 0px',
      threshold: 0
    };
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          document.querySelectorAll('.toc-link').forEach(link => {
            link.classList.remove('active');
          });
          
          const id = entry.target.getAttribute('id');
          const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
          if (activeLink) {
            activeLink.classList.add('active');
          }
        }
      });
    }, observerOptions);
    
    // Observe all h2 headings
    document.querySelectorAll('h2[id]').forEach(heading => {
      observer.observe(heading);
    });
  </script>
  
</body>
</html>

<style>
/* Basic Layout Structure */
.blog-container {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 3rem;
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

/* Main Content */
.blog-content {
  max-width: 800px;
}

.article-header {
  margin-bottom: 2rem;
}

.article-header h1 {
  font-size: 2.5rem;
  font-weight: 700;
  line-height: 1.2;
  margin-bottom: 1.5rem;
  color: #1a1a1a;
}

.author-meta {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin: 1rem 0;
}

.author-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
}

.article-meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #666;
  font-size: 0.9rem;
}

.hero-image {
  margin: 2rem 0;
  border-radius: 8px;
  overflow: hidden;
}

.hero-image img {
  width: 100%;
  height: auto;
  display: block;
}

/* Prose Styling (main content) */
.prose {
  font-size: 1.125rem;
  line-height: 1.75;
  color: #333;
}

.prose h2 {
  font-size: 1.875rem;
  font-weight: 700;
  margin: 2.5rem 0 1rem;
  color: #1a1a1a;
  scroll-margin-top: 100px; /* Account for sticky header */
}

.prose h3 {
  font-size: 1.5rem;
  font-weight: 600;
  margin: 2rem 0 1rem;
}

.prose p {
  margin: 1.25rem 0;
}

.prose ul, .prose ol {
  margin: 1.25rem 0;
  padding-left: 1.5rem;
}

.prose li {
  margin: 0.5rem 0;
}

.prose a {
  color: #0066cc;
  text-decoration: underline;
}

.prose a:hover {
  color: #0052a3;
}

.prose strong {
  font-weight: 600;
}

/* Sidebar */
.blog-sidebar {
  position: relative;
}

.sticky-section {
  position: sticky;
  top: 2rem;
  margin-bottom: 2rem;
  background: white;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  padding: 1.5rem;
}

/* Share Buttons */
.share-section h3 {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 1rem;
}

.share-buttons {
  display: flex;
  gap: 0.5rem;
}

.share-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 4px;
  transition: all 0.2s;
}

.share-button.twitter {
  background: #1da1f2;
  color: white;
}

.share-button.facebook {
  background: #1877f2;
  color: white;
}

.share-button.linkedin {
  background: #0a66c2;
  color: white;
}

.share-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Table of Contents */
.toc-section h3 {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 1rem;
}

.table-of-contents ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.table-of-contents li {
  margin: 0;
}

.toc-link {
  display: block;
  padding: 0.5rem 0;
  color: #666;
  text-decoration: none;
  font-size: 0.9rem;
  border-left: 2px solid transparent;
  padding-left: 1rem;
  transition: all 0.2s;
}

.toc-link:hover {
  color: #0066cc;
  border-left-color: #0066cc;
  background: #f8f9fa;
}

.toc-link.active {
  color: #0066cc;
  font-weight: 600;
  border-left-color: #0066cc;
  background: #f0f7ff;
}

/* CTA Box */
.cta-box {
  text-align: center;
}

.cta-box h3 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.cta-box p {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 1rem;
}

.cta-button {
  display: inline-block;
  padding: 0.75rem 1.5rem;
  background: #0066cc;
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 600;
  transition: all 0.2s;
}

.cta-button:hover {
  background: #0052a3;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,102,204,0.3);
}

/* Author Bio Card */
.author-bio-card {
  text-align: center;
}

.author-bio-card img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  margin: 0 auto 1rem;
}

.author-bio-card h4 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.author-bio-card .author-title {
  font-size: 0.85rem;
  color: #666;
  margin-bottom: 1rem;
}

.view-profile-link {
  color: #0066cc;
  text-decoration: none;
  font-size: 0.9rem;
}

.view-profile-link:hover {
  text-decoration: underline;
}

/* Mobile Responsive */
@media (max-width: 1024px) {
  .blog-container {
    grid-template-columns: 1fr;
  }
  
  .blog-sidebar {
    order: 1;
  }
  
  .blog-content {
    order: 2;
  }
  
  .sticky-section {
    position: relative;
    top: 0;
  }
}

@media (max-width: 768px) {
  .article-header h1 {
    font-size: 2rem;
  }
  
  .prose {
    font-size: 1rem;
  }
  
  .prose h2 {
    font-size: 1.5rem;
  }
}
</style>
