---
// Funnel A/B Test Router - Server-Side Redirect
// This page handles /funnel and /funnel/ and redirects to variant A or B

export const prerender = false; // Must be SSR for runtime logic

const FUNNEL_COOKIE_NAME = 'funnel_variant';
const FUNNEL_COOKIE_MAX_AGE = 2592000; // 30 days

// Get the request object
const request = Astro.request;
const url = new URL(request.url);

// Check for existing variant cookie
const cookieHeader = request.headers.get('Cookie') || '';
const existingVariant = cookieHeader
  .split('; ')
  .find(row => row.startsWith(`${FUNNEL_COOKIE_NAME}=`))
  ?.split('=')[1];

let variant: string;

if (existingVariant && (existingVariant === 'a' || existingVariant === 'b')) {
  // User already has a variant assigned, use it
  variant = existingVariant;
} else {
  // New user - assign variant based on 50/50 random split
  variant = Math.random() < 0.5 ? 'a' : 'b';
}

// Redirect to the variant page with trailing slash
const redirectUrl = new URL(`/funnel/${variant}/`, url.origin);

// Set cookie for new users
if (!existingVariant) {
  Astro.cookies.set(FUNNEL_COOKIE_NAME, variant, {
    path: '/',
    maxAge: FUNNEL_COOKIE_MAX_AGE,
    sameSite: 'lax',
    secure: true,
    httpOnly: false
  });
}

// Perform the redirect
return Astro.redirect(redirectUrl.toString(), 302);
---
